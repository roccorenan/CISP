name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Deploy on server runner
        run: |
          set -euxo pipefail
          cd /opt/cisp
          echo ":: git fetch/reset"
          git fetch origin main
          git reset --hard origin/main
          COMPOSE_FILE="docker-compose.linux.nginx.yml"
          echo ":: docker versions"
          docker --version || true
          if docker compose version >/dev/null 2>&1; then
            echo ":: using docker compose"
            docker compose -f "$COMPOSE_FILE" build
            docker compose -f "$COMPOSE_FILE" up -d --force-recreate
          elif command -v docker-compose >/dev/null 2>&1; then
            echo ":: using docker-compose"
            docker-compose -f "$COMPOSE_FILE" build
            docker-compose -f "$COMPOSE_FILE" up -d --force-recreate
          else
            echo "docker compose/docker-compose nÃ£o encontrados" >&2
            exit 1
          fi
          echo ":: docker ps"
          docker ps || true
