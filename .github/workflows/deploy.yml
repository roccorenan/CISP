name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Add SSH key from base64 secret (optional)
        env:
          SERVER_SSH_KEY_B64: ${{ secrets.SERVER_SSH_KEY_B64 }}
        run: |
          if [ -n "$SERVER_SSH_KEY_B64" ]; then
            echo "$SERVER_SSH_KEY_B64" | base64 -d > /tmp/ssh_key
            chmod 600 /tmp/ssh_key
            eval "$(ssh-agent -s)"
            ssh-add /tmp/ssh_key
          fi
      - uses: webfactory/ssh-agent@v0.9.0
        continue-on-error: true
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          ssh -o StrictHostKeyChecking=no -p "$SERVER_PORT" "$SERVER_USER@$SERVER_HOST" << 'EOF'
          set -e
          cd /opt/cisp
          git fetch origin main
          git reset --hard origin/main
          COMPOSE_FILE="docker-compose.linux.nginx.yml"
          if docker compose version >/dev/null 2>&1; then
            docker compose -f "$COMPOSE_FILE" build
            docker compose -f "$COMPOSE_FILE" up -d --force-recreate
          elif command -v docker-compose >/dev/null 2>&1; then
            docker-compose -f "$COMPOSE_FILE" build
            docker-compose -f "$COMPOSE_FILE" up -d --force-recreate
          else
            echo "docker compose/docker-compose nÃ£o encontrados" >&2
            exit 1
          fi
          EOF
