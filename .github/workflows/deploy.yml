name: ğŸš€ Deploy ProduÃ§Ã£o

on:
  push:
    branches:
      - main
  workflow_dispatch:   # permite rodar manualmente pela UI do GitHub

jobs:
  deploy:
    name: Deploy no Servidor Linux
    runs-on: ubuntu-latest

    steps:

      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      # â”€â”€ 2. Valida sintaxe Python antes de deployar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ Verificar sintaxe Python
        run: |
          python -m py_compile app.py
          echo "âœ… app.py â€” sintaxe OK"

      # â”€â”€ 3. Deploy via SSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key:      ${{ secrets.SERVER_SSH_KEY }}
          port:     ${{ secrets.SERVER_PORT }}
          script: |
            set -e   # para tudo se qualquer comando falhar

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  Deploy CISP â€” $(date '+%Y-%m-%d %H:%M:%S')"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            cd /opt/cisp

            # Puxa o cÃ³digo mais recente
            echo "ğŸ“¥ git pull origin main..."
            git pull origin main

            # ReconstrÃ³i a imagem com o novo cÃ³digo
            echo "ğŸ”¨ docker-compose build..."
            docker-compose build --no-cache

            # Sobe o container (substitui o antigo sem downtime perceptÃ­vel)
            echo "ğŸ”„ docker-compose up -d..."
            docker-compose up -d

            # Remove imagens antigas para liberar espaÃ§o em disco
            echo "ğŸ§¹ Limpando imagens antigas..."
            docker image prune -f

            # Aguarda o container inicializar e verifica o health-check
            echo "â³ Aguardando health-check (15s)..."
            sleep 15
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' cisp-web 2>/dev/null || echo "sem health-check")
            echo "ğŸ“Š Status do container: $STATUS"

            echo ""
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸŒ http://$(hostname -I | awk '{print $1}'):5000"
